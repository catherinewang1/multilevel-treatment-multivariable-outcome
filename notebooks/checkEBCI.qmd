---
title: "checkEBCI"
format: html
editor: source
toc: true
toc-depth: 2
---




Goal: Check the EBCI shrinkage process, especially for kmeans clustering results. The estimates are being shrunk towards the overall mean very strongly.




```{r}


suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(ebci))

source('../utils/cluster_and_ebci_shrinkage.r')


ebci_results = readRDS('../saves/cluster_and_ebci_results_cellsamplesplit.rds')

ebci_results = ebci_results[['1/se**2']]

method_nice_names = list('sceptre'='SCEPTRE',
                         'poisson'='Poisson',
                         'nb'     ='Negative Binomial')
alpha = .1
```


# SCEPTRE kmeans 2 vs kmeans 3


## EBCI Confidence Interval Lengths 

We focus on SCEPTRE with kmeans 2 vs kmeans 3 clusters. kmeans with 2 clusters seems to give reasonable results, where the CI lengths are reasonable, but kmeans with 3 clusters gives very small CI lengths. These lengths are recorded in the ebci object result's dataframe column `len_eb`. (The plots displayed show this value, but this value would actually be 1/2 of the CI length because the CI's are constructed by  estimate $\pm$ `len_eb`)





```{r}
# chosen_methods = list('1' = c('sceptre', 'kmeans2'),
#                       '2' = c('sceptre', 'kmeans3'))
chosen_methods = list('1' = c('sceptre', 'kmeans2'),
                      '2' = c('sceptre', 'kmeans3'),
                      '3' = c('sceptre', 'myKmeans2'),
                      '4' = c('sceptre', 'myKmeans3'))

len_eb_df = NULL
for(i in names(chosen_methods)) {
  
  est_method = chosen_methods[[i]][1]
  cl_method = chosen_methods[[i]][2]
  
  # names(ebci_results[[est_method]][[cl_method]])
  # ebci_results[[est_method]][[cl_method]]$ebci_obj
  
  len_eb_df = rbind(len_eb_df, 
                    data.frame(est_method = est_method,
                               cl_method  = cl_method, 
                               len_eb = ebci_results[[est_method]][[cl_method]]$ebci_obj$df$len_eb))
}

ggplot(len_eb_df, 
       aes(x = len_eb, group = cl_method, fill = cl_method)) +
  geom_histogram(position = 'dodge') +
  labs(title = 'EBCI CI lengths on SCEPTRE Estimates') +
  theme_classic()
```


## Look at the original unshrunk estimates and the cluster assignments



```{r}

chosen_methods = list('1' = c('sceptre', 'kmeans2'),
                      '2' = c('sceptre', 'kmeans3'))

plot_df = NULL
for(i in names(chosen_methods)) {
  
  est_method = chosen_methods[[i]][1]
  cl_method = chosen_methods[[i]][2]
  
  
  shrunk_df = ebci_results[[est_method]][[cl_method]]$ebci_df |>
              filter(train01 == 0) |>
              select(pvalue, cluster, shrinkage_point, unshrunk_value, shrunk_value, se, 
                     lower_ci, upper_ci) |>
              mutate(est_method = est_method,
                     cl_method  = cl_method)
  # colnames(shrunk_df)
  
  plot_df = rbind(plot_df,
                  shrunk_df)
}

# original unshrunk values
ggplot(plot_df) +
  geom_histogram(aes(x = unshrunk_value)) +
  geom_vline(aes(xintercept =shrinkage_point)) +
  facet_grid(rows = vars(cl_method), 
             cols = vars(cluster)) +
  labs(title = 'Unshrunk Value') +
  theme_classic()

# se: standard error (input into ebci shrinakge)
ggplot(plot_df) +
  geom_histogram(aes(x = se)) +
  facet_grid(rows = vars(cl_method), 
             cols = vars(cluster)) +
  scale_x_continuous(limits = c(0, 1)) +
  labs(title = 'SE', x = 'se (x axis cutoff)') +
  theme_classic()



# 1/se**2: potential weight choice
ggplot(plot_df) +
  geom_histogram(aes(x = 1/se**2)) +
  facet_grid(rows = vars(cl_method), 
             cols = vars(cluster)) +
  scale_x_continuous(limits = c(0, 1)) +
  labs(title = '1/SE**2', x = '1/se**2 (x axis cutoff)') +
  theme_classic()


# distance from shrinkage point
ggplot(plot_df |> mutate(distance = unshrunk_value - shrinkage_point)) +
  geom_histogram(aes(x = distance)) +
  facet_grid(rows = vars(cl_method), 
             cols = vars(cluster)) +
  scale_x_continuous(limits = c(0, 1)) +
  labs(title = 'Distance from shrinkage point', x = 'distance') +
  theme_classic()

# CI length
ggplot(plot_df |> mutate(ci_length = upper_ci - lower_ci)) +
  geom_histogram(aes(ci_length)) +
  facet_grid(rows = vars(cl_method), 
             cols = vars(cluster)) +
  scale_x_continuous(limits = c(-.1, 1)) +
  labs(title = 'CI length', x = 'CI length') +
  theme_classic()


# unshrunk vs shrunk values
ggplot(plot_df, 
       aes(x = unshrunk_value, 
           y = shrunk_value)) +
  geom_abline(aes(slope = 1, intercept = 0), color = 'gray35') +
  geom_point(size = 1, alpha = .6) +
  scale_y_continuous(limits = c(-.7, .5)) +
  scale_x_continuous(limits = c(-1, 1)) +
  facet_grid(rows = vars(cl_method), 
             cols = vars(cluster), scale='free') +
  theme_bw() +
  theme(panel.grid.minor = element_blank())


sample_idx = seq(from = 0, to = nrow(plot_df), length.out = 1000) |> round()
ggplot(plot_df |>
               # slice(seq(from = 1, to = n(), by = floor(n()/400))) |>
               slice(sample_idx) |>
               arrange(cl_method, cluster) |>
               mutate(# test = factor(test, levels = c('negative', 'positive', 'discovery')),
                      x = 1:n()),
             aes(x = x)) +
    # geom_point(aes(y = lower_ci) )+
    # geom_point(aes(y = upper_ci)) +
    # geom_point(aes(y = -1.5, color = cluster)) +
    geom_hline(aes(yintercept = 0)) +
    geom_segment(aes(y = lower_ci, yend = upper_ci),
                 lineend = 'square', linewidth = 1, alpha = .7, color = 'deepskyblue4') +
    # geom_segment(aes(y = unshrunk_value, yend = .99 * shrunk_value + .01 * unshrunk_value),
    #              lineend = 'square', linejoin = 'bevel', arrow = arrow(length = unit(0.2,"cm")),
    #              linewidth = .3, alpha = .7, color = 'deepskyblue2') +
    geom_point(aes(y = unshrunk_value), color = 'deepskyblue2', shape = 0, size = 1) +
    geom_point(aes(y = shrunk_value),   color = 'deepskyblue2', shape = 4, size = 1) +
    geom_point(aes(y = shrinkage_point), color = 'orange', shape = '-', size = 3) +
    scale_x_continuous(expand = c(0, 0), breaks = seq(0, 1000, by = 100),
                       # limits = c(1, 90)) +
                       # limits = c(65, 175)) +
                       # limits = c(95, 400)) +
                       # limits = c(1, 400)) +
    ) +
    scale_y_continuous(expand = c(0.025, 0)) +
    # coord_cartesian(ylim = c(-2, 2)) +
    coord_cartesian(ylim = c(-.2, .2)) + # very zoomed in
    # scale_color_discrete(type = c('darkgreen', 'firebrick', 'gold3'),
    #                      guide = guide_legend(direction = 'horizontal')) +
    facet_grid(cols = vars(cl_method), scales = 'free') +
    labs(x = 'AY Test', y = '...',
         title = 'EBCI',
         subtitle = 'Before and After Robust EBCI') +
    theme_bw() +
    theme(panel.grid.minor.x = element_blank()) 

```



```{r}
plot_df |> 
  mutate(distance = unshrunk_value - shrinkage_point) |>
  group_by(cl_method, cluster) |> 
  
  summarize(distance_sq_mean = mean(distance**2),
            distance_sq_sd = sd(distance**2),
            se_mean = mean(se),
            se_sd   = sd(se), .groups = 'drop')


plot_df |> 
  mutate(distance = unshrunk_value - shrinkage_point) |>
  group_by(cl_method, cluster) |>
  # group_by(cl_method) |> 
  summarize(distance_sq_mean = weighted.mean(distance**2, w = 1/se**2) |> round(5),
            unweighted_distance_sq_mean = mean(distance**2) |> round(3),
            # distance_sq_sd = sd(distance**2),
            se_mean = mean(se) |> round(2),
            # se_sd   = sd(se), 
            n = n(),
            .groups = 'drop') |> knitr::kable(format = "latex")
```


## Re-Fit EBCI to double check

```{r}
chosen_methods = list('1' = c('sceptre', 'kmeans2'),
                      '2' = c('sceptre', 'kmeans3'))

ebci_df = NULL
for(i in names(chosen_methods)) {
  
  est_method = chosen_methods[[i]][1]
  cl_method = chosen_methods[[i]][2]
  
  
  shrunk_df = ebci_results[[est_method]][[cl_method]]$ebci_df |>
              filter(train01 == 0) |>
              select(pvalue, cluster, shrinkage_point, unshrunk_value, se) |>
              mutate(est_method = est_method,
                     cl_method  = cl_method)
  # colnames(shrunk_df)
  
  
  
  ebci_obj = ebci(formula = 'unshrunk_value - shrinkage_point ~ 0', # ebci_formula
                    data    = shrunk_df,  
                    se = se, weights = 1/se^2, alpha = alpha)
  # same estimates as the saved ebci_obj
  # [1] "sceptre kmeans2: mu2 = 0.0120930966, kappa = 13581.8"
  # [1] "sceptre kmeans3: mu2 = 0.0000000442, kappa = 1015756530743912.2"
  print(sprintf("%s %s: mu2 = %.10f, kappa = %.1f", 
                est_method, cl_method,
                ebci_obj$mu2[1],
                ebci_obj$kappa[1])) 
  
  ebci_df = rbind(ebci_df,
                  shrunk_df |> 
                  mutate(shrunk_value = ebci_obj$df$th_eb + shrinkage_point,
                         lower_ci = shrunk_value - ebci_obj$df$len_eb,
                         upper_ci = shrunk_value + ebci_obj$df$len_eb, 
                         len_eb = ebci_obj$df$len_eb))
}





```



```{r}
ggplot(ebci_df, 
       aes(x = len_eb, group = cl_method, fill = cl_method)) +
  geom_histogram(position = 'dodge') +
  labs(title = 'EBCI CI lengths on SCEPTRE Estimates') +
  theme_classic()
```



## Fit with equal weights (prev 1/se**2)

Now CI lengths are reasonable for both kmeans2 and kmeans3. Before kmeans3 had very small CI lengths.

The estimates for $\mu_2$ and $\kappa$ are suspiciously close to each other.

Now, all the estimates basically do not shrink at all? Before kmeans2 shrunk reasonably and kmeans3 shrunk very much to the specified shrinkage point.



```{r}

chosen_methods = list('1' = c('sceptre', 'kmeans2'),
                      '2' = c('sceptre', 'kmeans3'))

ebci_equal_df = NULL
for(i in names(chosen_methods)) {
  
  est_method = chosen_methods[[i]][1]
  cl_method = chosen_methods[[i]][2]
  
  
  shrunk_df = ebci_results[[est_method]][[cl_method]]$ebci_df |>
              filter(train01 == 0) |>
              select(pvalue, cluster, shrinkage_point, unshrunk_value, se) |>
              mutate(est_method = est_method,
                     cl_method  = cl_method)
  # colnames(shrunk_df)
  
  # estimates are suspiciously close
  # [1] "sceptre kmeans2: mu2 = 295.1850145509, kappa = 152161.5"
  # [1] "sceptre kmeans3: mu2 = 295.1850145509, kappa = 152161.6"
  ebci_obj = ebci(formula = 'unshrunk_value - shrinkage_point ~ 0', # ebci_formula
                    data    = shrunk_df |> mutate(ones = 1/n()),  
                    se = se, weights = ones, alpha = alpha)
  
  print(sprintf("%s %s: mu2 = %.10f, kappa = %.1f", 
                est_method, cl_method,
                ebci_obj$mu2[1],
                ebci_obj$kappa[1]))
  
  ebci_equal_df = rbind(ebci_equal_df,
                  shrunk_df |> 
                  mutate(shrunk_value = ebci_obj$df$th_eb + shrinkage_point,
                         lower_ci = shrunk_value - ebci_obj$df$len_eb,
                         upper_ci = shrunk_value + ebci_obj$df$len_eb, 
                         len_eb = ebci_obj$df$len_eb))
}



```


```{r}


ebci_equal_df |>
  mutate(distance = unshrunk_value - shrinkage_point) |> 
  group_by(cl_method) |>
  summarize(sd = sd(distance))

ebci_equal_df  |>
  mutate(distance2 = (unshrunk_value - shrinkage_point)**2) |> 
  group_by(cl_method) |>
  summarize(mean(distance2))

```



```{r}
ggplot(ebci_equal_df, 
       aes(x = len_eb, group = cl_method, fill = cl_method)) +
  geom_histogram(position = 'dodge') +
  scale_x_continuous(limits = c(0, 10)) +
  labs(title = 'Equally Weighted EBCI CI lengths on SCEPTRE Estimates') +
  theme_classic()



colnames(ebci_equal_df)
sample_idx = seq(from = 0, to = nrow(ebci_equal_df), length.out = 1000) |> round()

ggplot(ebci_equal_df |>
               # slice(seq(from = 1, to = n(), by = floor(n()/400))) |>
               slice(sample_idx) |>
               arrange(cl_method, cluster) |>
               mutate(# test = factor(test, levels = c('negative', 'positive', 'discovery')),
                      x = 1:n()),
             aes(x = x)) +
    # geom_point(aes(y = lower_ci) )+
    # geom_point(aes(y = upper_ci)) +
    # geom_point(aes(y = -1.5, color = cluster)) +
    geom_hline(aes(yintercept = 0)) +
    geom_segment(aes(y = lower_ci, yend = upper_ci),
                 lineend = 'square', linewidth = 1, alpha = .7, color = 'deepskyblue4') +
    # geom_segment(aes(y = unshrunk_value, yend = .99 * shrunk_value + .01 * unshrunk_value),
    #              lineend = 'square', linejoin = 'bevel', arrow = arrow(length = unit(0.2,"cm")),
    #              linewidth = .3, alpha = .7, color = 'deepskyblue2') +
    geom_point(aes(y = unshrunk_value), color = 'deepskyblue2', shape = 0, size = 3) +
    geom_point(aes(y = shrunk_value),   color = 'deepskyblue2', shape = 4, size = 3) +
    geom_point(aes(y = shrinkage_point), color = 'orange', shape = '-', size = 3) +
    scale_x_continuous(expand = c(0, 0), breaks = seq(0, 1000, by = 10),
                       # limits = c(1, 90)) +
                       # limits = c(65, 175)) +
                       # limits = c(95, 400)) +
                       # limits = c(1, 400)) +
    ) +
    scale_y_continuous(expand = c(0.025, 0), limits = c(-2.5, 2.5)) +
    # scale_y_continuous(expand = c(0.025, 0), limits = c(-1.5, .75)) +
    # scale_color_discrete(type = c('darkgreen', 'firebrick', 'gold3'),
    #                      guide = guide_legend(direction = 'horizontal')) +
    facet_grid(cols = vars(cl_method), scales = 'free') +
    labs(x = 'AY Test', y = '...',
         title = 'Equal Weight EBCI',
         subtitle = 'Before and After Robust EBCI') +
    theme_bw() +
    theme(panel.grid.minor.x = element_blank()) #,
          # legend.position = 'inside',
          # legend.position.inside = c(.9, .9),
          #legend.background = element_rect(color = 'black'))

# unshrunk vs shrunk values
ggplot(ebci_equal_df, 
       aes(x = unshrunk_value, 
           y = shrunk_value)) +
  geom_abline(aes(slope = 1, intercept = 0), color = 'gray35') +
  geom_point(size = 1, alpha = .6) +
  scale_y_continuous(limits = c(-.7, .5)) +
  scale_x_continuous(limits = c(-1, 1)) +
  facet_grid(rows = vars(cl_method), 
             cols = vars(cluster), scale='free') +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
```




## Fit with 1/se**4

Using the weights $1/se^4$ is supposed to be optimal for the estimation of $\mu_2$. (This fit takes a long time for some reason.)

```{r}

chosen_methods = list('1' = c('sceptre', 'kmeans2'),
                      '2' = c('sceptre', 'kmeans3'))

ebci_se4_df = NULL
for(i in names(chosen_methods)) {
  
  est_method = chosen_methods[[i]][1]
  cl_method = chosen_methods[[i]][2]
  
  
  shrunk_df = ebci_results[[est_method]][[cl_method]]$ebci_df |>
              filter(train01 == 0) |>
              select(pvalue, cluster, shrinkage_point, unshrunk_value, se) |>
              mutate(est_method = est_method,
                     cl_method  = cl_method)
  # colnames(shrunk_df)
  
  ebci_obj = ebci(formula = 'unshrunk_value - shrinkage_point ~ 0', # ebci_formula
                    data    = shrunk_df,  
                    se = se, weights = 1/se^4, alpha = alpha)
  
  # [1] "sceptre kmeans2: mu2 = 0.0164014485, kappa = 1.0"
  # [1] "sceptre kmeans3: mu2 = 0.0000010267, kappa = 42.5"
  print(sprintf("%s %s: mu2 = %.10f, kappa = %.1f", 
                est_method, cl_method,
                ebci_obj$mu2[1],
                ebci_obj$kappa[1]))
  
  ebci_se4_df = rbind(ebci_se4_df,
                  shrunk_df |> 
                  mutate(shrunk_value = ebci_obj$df$th_eb + shrinkage_point,
                         lower_ci = shrunk_value - ebci_obj$df$len_eb,
                         upper_ci = shrunk_value + ebci_obj$df$len_eb, 
                         len_eb = ebci_obj$df$len_eb))
}



```



```{r}
# len_eb histogram
ggplot(ebci_se4_df, 
       aes(x = len_eb, group = cl_method, fill = cl_method)) +
  geom_histogram(position = 'dodge') +
  # scale_x_continuous(limits = c(-.1, 10)) +
  labs(title = '1/se^4 Weighted EBCI len_eb on SCEPTRE Estimates') +
  theme_classic()




sample_idx = seq(from = 0, to = nrow(ebci_se4_df), length.out = 1000) |> round()

ggplot(ebci_se4_df |>
               slice(sample_idx) |>
               arrange(cl_method, cluster) |>
               mutate(x = 1:n()),
             aes(x = x)) +
    geom_hline(aes(yintercept = 0)) +
    geom_segment(aes(y = lower_ci, yend = upper_ci),
                 lineend = 'square', linewidth = 1, alpha = .7, color = 'deepskyblue4') +
    geom_point(aes(y = unshrunk_value), color = 'deepskyblue2', shape = 0, size = 3) +
    geom_point(aes(y = shrunk_value),   color = 'deepskyblue2', shape = 4, size = 3) +
    geom_point(aes(y = shrinkage_point), color = 'orange', shape = '-', size = 3) +
    scale_x_continuous(expand = c(0, 0), breaks = seq(0, 1000, by = 50)) +
    scale_y_continuous(expand = c(0.025, 0)) +
    coord_cartesian(ylim = c(-2, 2)) +
    # coord_cartesian(ylim = c(-.2, .2)) + # very zoomed in
    facet_grid(cols = vars(cl_method), scales = 'free') +
    labs(x = 'AY Test', y = '...',
         title = '1/se^4 Weight EBCI',
         subtitle = 'Before and After Robust EBCI') +
    theme_bw() +
    theme(panel.grid.minor.x = element_blank()) 


# unshrunk vs shrunk values
ggplot(ebci_se4_df, 
       aes(x = unshrunk_value, 
           y = shrunk_value)) +
  geom_abline(aes(slope = 1, intercept = 0), color = 'gray35') +
  geom_point(size = 1, alpha = .6) +
  scale_y_continuous(limits = c(-.7, .5)) +
  scale_x_continuous(limits = c(-1, 1)) +
  facet_grid(rows = vars(cl_method), 
             cols = vars(cluster), scale='free') +
  theme_bw() +
  theme(panel.grid.minor = element_blank())
```




## Check ebci object fitted parameters
```{r}

chosen_methods = list('1' = c('sceptre', 'kmeans2'),
                      '2' = c('sceptre', 'kmeans3'))

for(i in names(chosen_methods)) {
  
  est_method = chosen_methods[[i]][1]
  cl_method = chosen_methods[[i]][2]
  
  
  ebci_obj =  ebci_results[[est_method]][[cl_method]]$ebci_obj
  # colnames(shrunk_df)
  
  # names(ebci_obj)
  # we care about the estimated mu2 (second moment), first element is the finite 
  # sample corrected version and kappa (kurtosis), also first element is the 
  # finite sample corrected version
  print(sprintf("%s %s: mu2 = %.10f, kappa = %.1f", 
                est_method, cl_method,
                ebci_obj$mu2[1],
                ebci_obj$kappa[1]))
}

```









# Testing Shrinkage all at once vs by cluster


Maybe shrinking all at once leads to a larger sample size and a smaller estimate of mu2 (doubtful though). This following code compares performing shrinkage on all the estimates at once to performing shrinkage on each cluster individually. The results should not be the exact same, but they will probably be similar. I think they could potentialy be different if there is a large difference in the standard errors and distance from the shrinkage points between clusters (e.g. if cluster 1 is very tight and has small sd vs cluster 2 is very wide and has large sd. Then, this information is all combined when performing shrinkage all at once.)

```{r}

value_colname = 'unshrunk_value'
se_colname = "se"
alpha = .1
chosen_methods = list('1' = c('sceptre', 'kmeans2'),
                      '2' = c('sceptre', 'kmeans3'))

res = list()

for(i in names(chosen_methods)) {
  # est_method = 'sceptre'
  # cl_method = 'kmeans3'
  res[[i]] = list()
  est_method = chosen_methods[[i]][1]
  cl_method = chosen_methods[[i]][2]
  
  # df with estimates, se, shrunk estimates, cluster, ...
  shrunk_df = ebci_results[[est_method]][[cl_method]]$ebci_df |>
                filter(train01 == 0) |>
                mutate(test = factor(test, 
                                     levels = c('negative', 'positive', 'discovery'))) |>
                arrange(test)
  
  shrunk_df = shrunk_df |> arrange(cluster)
  
  # look at what is wrong...
  # look at the shrinkage
  res[[i]][['originalShrinkagePlot']] =   plot_shrinkage2(shrunk_df        = shrunk_df,
                  unshrunk_colname = 'unshrunk_value',
                  shrunk_colname   = 'shrunk_value',
                  CIlower_colname  = 'lower_ci',
                  CIupper_colname  = 'upper_ci',
                  sample_idx        = 'default subsample',
                  title            = paste0(method_nice_names[[est_method]], ' + ', cl_method),
                  legend_position  = c(.81, .12))

  res[[i]][['originalValuesSummary']] = shrunk_df |> group_by(cluster) |>
    summarize(shrinkage_point = mean(shrinkage_point),
              shrinkage_point_sd = sd(shrinkage_point), # should be 0
              unshrunk_mean = mean(unshrunk_value),
              unshrunk_sd   = sd(unshrunk_value),
              shrunk_mean = mean(shrunk_value),
              shrunk_sd   = sd(shrunk_value))
  
  # colnames(shrunk_df)
  # #  [1] "train01"         "test"            "grna"            "gene"           
  # #  [5] "pvalue"          "pr1"             "pr2"             "pr3"            
  # #  [9] "cluster"         "shrinkage_point" "unshrunk_value"  "se"             
  # # [13] "shrunk_value"    "lower_ci"        "upper_ci" 
  
  

  
  
  ebci_obj = ebci(formula = 'unshrunk_value - shrinkage_point ~ 0', # ebci_formula
                    data    = shrunk_df,  
                    se = se, weights = 1/se^2, alpha = alpha)
  
  res[[i]][['ebciObjectAllAtOnce']] = ebci_obj
  
  shrunk_values_allatonce = ebci_obj$df$th_eb + shrunk_df$shrinkage_point

  # vs group by group 
  shrunk_values_bygroup = rep(NA, nrow(shrunk_df))
  estimated_params_bygroup = list()
  for(k in 1:3) {
    k_idx = which(shrunk_df$cluster == k)
    if(length(k_idx) == 0) {
      next
    }
    ebci_obj_k = ebci(formula = 'unshrunk_value - shrinkage_point ~ 0', # ebci_formula
                      data    = shrunk_df[k_idx, ],  
                      se = se, weights = 1/se^2, alpha = .1)
    
    shrunk_values_bygroup[k_idx] = ebci_obj_k$df$th_eb + shrunk_df[k_idx, 'shrinkage_point']
    estimated_params_bygroup[[k]] = ebci_obj_k[c('mu2', 'kappa', 'delta')]
    
    res[[i]][[paste0('ebciObjectByGroup', k)]] = ebci_obj_k
  }
  
  estimated_params_bygroup[['atonce']]  =  ebci_obj[c('mu2', 'kappa', 'delta')]
  
  res[[i]][['ebciParams']] = estimated_params_bygroup
  
  # compare
  df = data.frame(unshrunk = shrunk_df$unshrunk_value,
                  atonce = shrunk_values_allatonce,
                  bygroup = shrunk_values_bygroup) |>
       mutate(difference = atonce - bygroup,
              cluster = shrunk_df$cluster,
              x = 1:n())
  
  
  
  res[[i]][['dfCompare']] = df
  res[[i]][['plotCompare1']] = 
    ggplot(reshape2::melt(df, id.vars = c('cluster', 'x'))) + 
      geom_point(aes(x=x, y = value, color = cluster |> factor())) +
      facet_grid(rows = vars(variable)) + 
      theme_bw()
  
  res[[i]][['plotCompare2']] = 
    ggplot(df) + 
        geom_abline(aes(intercept = 0, slope = 1), color = 'gray', alpha = .7) +
        geom_point(aes(x=atonce, y = bygroup, color = cluster |> factor())) + 
        theme_bw()
  
}











```


```{r}
# colnames(shrunk_df)
# #  [1] "train01"         "test"            "grna"            "gene"           
# #  [5] "pvalue"          "pr1"             "pr2"             "pr3"            
# #  [9] "cluster"         "shrinkage_point" "unshrunk_value"  "se"             
# # [13] "shrunk_value"    "lower_ci"        "upper_ci" 


value_colname = 'unshrunk_value'
se_colname = "se"
alpha = .1


ebci_obj = ebci(formula = 'unshrunk_value - shrinkage_point ~ 0', # ebci_formula
                  data    = shrunk_df,  
                  se = se, weights = 1/se^2, alpha = .1)


shrunk_values_allatonce = ebci_obj$df$th_eb + shrunk_df$shrinkage_point

# vs group by group 
shrunk_values_bygroup = rep(NA, nrow(shrunk_df))
estimated_params_bygroup = list()
for(k in 1:3) {
  k_idx = which(shrunk_df$cluster == k)

  ebci_obj_k = ebci(formula = 'unshrunk_value - shrinkage_point ~ 0', # ebci_formula
                  data    = shrunk_df[k_idx, ],  
                  se = se, weights = 1/se^2, alpha = .1)
  
  shrunk_values_bygroup[k_idx] = ebci_obj_k$df$th_eb + shrunk_df[k_idx, 'shrinkage_point']
  estimated_params_bygroup[[k]] = ebci_obj_k[c('mu2', 'kappa', 'delta')]
}

estimated_params_bygroup[['atonce']]  =  ebci_obj[c('mu2', 'kappa', 'delta')]
```



```{r}
# compare
df = data.frame(atonce = shrunk_values_allatonce,
                bygroup = shrunk_values_bygroup) |>
     mutate(difference = atonce - bygroup,
            cluster = shrunk_df$cluster,
            x = 1:n())

ggplot(reshape2::melt(df, id.vars = c('cluster', 'x'))) + 
  geom_point(aes(x=x, y = value, color = cluster |> factor())) +
  facet_grid(rows = vars(variable)) + 
  theme_bw()

# the difference between doing shrinkage all at once or by each cluster is minimal
plot(shrunk_values_allatonce)
plot(shrunk_values_bygroup)
plot(df$difference)


```





```{r}

names(res[['1']])

# compare parameters
param_list = list()
for(i in names(chosen_methods)) {
  
  param_list[[paste0(i)]] = res[[i]]$ebciParams$atonce
  # plot_list[[paste0(i, '2')]] = res[[i]][['plotCompare1']]
}


```


```{r}

# compare plots
plot_list = list()
for(i in names(chosen_methods)) {
  
  plot_list[[paste0(i, '1')]] = res[[i]][['plotCompare1']]
  plot_list[[paste0(i, '2')]] = res[[i]][['plotCompare1']]
}

gridExtra::grid.arrange(grobs = plot_list, nrow = 2)
```




